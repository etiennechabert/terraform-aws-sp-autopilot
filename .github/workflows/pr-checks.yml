name: PR Checks

on:
  pull_request:
    branches:
      - main
      - develop
  push:
    branches:
      - main
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

jobs:
  # Stage 1: Fast validation checks (run first)
  terraform-validation:
    name: Terraform Format and Validate
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: "1.11.0"

      - name: Terraform Format Check
        id: fmt
        run: |
          # Format check for .tf files only (tftest.hcl files are not supported by terraform fmt)
          find . -name "*.tf" -not -path "*/.terraform/*" -exec terraform fmt -check {} +
        continue-on-error: false

      - name: Terraform Init
        id: init
        run: terraform init -backend=false
        continue-on-error: false

      - name: Terraform Validate
        id: validate
        run: terraform validate
        continue-on-error: false

      - name: Comment PR with Results
        if: false # Disabled: github.event_name == 'pull_request' && failure()
        uses: actions/github-script@v8
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const output = `#### Terraform Validation Failed ❌

            **Format Check:** \`${{ steps.fmt.outcome }}\`
            **Initialization:** \`${{ steps.init.outcome }}\`
            **Validation:** \`${{ steps.validate.outcome }}\`

            *Pushed by: @${{ github.actor }}, Action: \`${{ github.event_name }}\`*`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: output
            });

  tfsec-scan:
    name: tfsec Security Scan
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Run tfsec
        uses: aquasecurity/tfsec-action@v1.0.3
        with:
          soft_fail: false
          format: default
          github_token: ${{ secrets.GITHUB_TOKEN }}
          additional_args: --minimum-severity HIGH --exclude aws-s3-encryption-customer-key,aws-sqs-queue-encryption-use-cmk,aws-iam-no-policy-wildcards

      - name: Run tfsec with SARIF output
        if: always()
        uses: aquasecurity/tfsec-sarif-action@v0.1.4
        with:
          sarif_file: tfsec-results.sarif
          github_token: ${{ secrets.GITHUB_TOKEN }}
          tfsec_args: --minimum-severity HIGH --exclude aws-s3-encryption-customer-key,aws-sqs-queue-encryption-use-cmk,aws-iam-no-policy-wildcards
        continue-on-error: true

      - name: Upload SARIF file
        if: always() && hashFiles('tfsec-results.sarif') != ''
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: tfsec-results.sarif
          category: tfsec

      - name: Comment PR with Security Issues
        if: false # Disabled: github.event_name == 'pull_request' && failure()
        uses: actions/github-script@v8
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const output = `#### Security Scan Failed ❌

            **tfsec found HIGH or CRITICAL security issues in your Terraform code.**

            Please review the security findings above and address them before merging.

            Common fixes:
            - Enable encryption for resources
            - Restrict security group rules
            - Enable logging and monitoring
            - Use secure default configurations

            *Pushed by: @${{ github.actor }}, Action: \`${{ github.event_name }}\`*`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: output
            });

  # Stage 1: Fast validation checks (run first)
  lint:
    name: Python Linting
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.13'

      - name: Install ruff
        run: |
          python -m pip install --upgrade pip
          pip install ruff

      - name: Run ruff check
        run: |
          ruff check lambda/

      - name: Run ruff format check
        run: |
          ruff format --check lambda/

      - name: Comment PR with Linting Results
        if: false # Disabled: github.event_name == 'pull_request' && failure()
        uses: actions/github-script@v8
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const output = `#### Python Linting Failed ❌

            **Ruff linting or formatting checks failed.**

            Please run the following commands locally to fix:
            - \`ruff check --fix lambda/\`
            - \`ruff format lambda/\`

            *Pushed by: @${{ github.actor }}, Action: \`${{ github.event_name }}\`*`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: output
            });

  # Stage 2: Lambda tests (runs after Stage 1 passes)
  scheduler-tests:
    needs: [terraform-validation, tfsec-scan, lint]
    name: Scheduler Lambda Tests
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.13'
          cache: 'pip'
          cache-dependency-path: 'lambda/scheduler/requirements.txt'

      - name: Install dependencies
        working-directory: lambda/scheduler
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run pytest with coverage
        working-directory: lambda/scheduler
        env:
          PYTHONPATH: ${{ github.workspace }}/lambda
          AWS_DEFAULT_REGION: us-east-1
        run: |
          pytest

      - name: Upload coverage artifact
        uses: actions/upload-artifact@v6
        with:
          name: scheduler-coverage
          path: lambda/scheduler/coverage.xml
          retention-days: 1

      - name: Upload coverage reports to Codecov
        uses: codecov/codecov-action@v5
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: ./lambda/scheduler/coverage.xml
          flags: scheduler
          name: scheduler-coverage
          fail_ci_if_error: false

      - name: Comment PR with Test Results
        if: false # Disabled: github.event_name == 'pull_request' && failure()
        uses: actions/github-script@v8
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const output = `#### Scheduler Lambda Tests Failed ❌

            **Pytest execution failed or coverage is below 80%.**

            Please review the test results above and fix any failing tests or improve test coverage.

            *Pushed by: @${{ github.actor }}, Action: \`${{ github.event_name }}\`*`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: output
            });

  purchaser-tests:
    needs: [terraform-validation, tfsec-scan, lint]
    name: Purchaser Lambda Tests
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.13'
          cache: 'pip'
          cache-dependency-path: 'lambda/purchaser/requirements.txt'

      - name: Install dependencies
        working-directory: lambda/purchaser
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run pytest with coverage
        working-directory: lambda/purchaser
        env:
          PYTHONPATH: ${{ github.workspace }}/lambda
          AWS_DEFAULT_REGION: us-east-1
        run: |
          pytest

      - name: Upload coverage artifact
        uses: actions/upload-artifact@v6
        with:
          name: purchaser-coverage
          path: lambda/purchaser/coverage.xml
          retention-days: 1

      - name: Upload coverage reports to Codecov
        uses: codecov/codecov-action@v5
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: ./lambda/purchaser/coverage.xml
          flags: purchaser
          name: purchaser-coverage
          fail_ci_if_error: false

      - name: Comment PR with Test Results
        if: false # Disabled: github.event_name == 'pull_request' && failure()
        uses: actions/github-script@v8
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const output = `#### Purchaser Lambda Tests Failed ❌

            **Pytest execution failed or coverage is below 80%.**

            Please review the test results above and fix any failing tests or improve test coverage.

            *Pushed by: @${{ github.actor }}, Action: \`${{ github.event_name }}\`*`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: output
            });

  reporter-tests:
    needs: [terraform-validation, tfsec-scan, lint]
    name: Reporter Lambda Tests
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.13'
          cache: 'pip'
          cache-dependency-path: 'lambda/reporter/requirements.txt'

      - name: Install dependencies
        working-directory: lambda/reporter
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run pytest with coverage
        working-directory: lambda/reporter
        env:
          PYTHONPATH: ${{ github.workspace }}/lambda
          AWS_DEFAULT_REGION: us-east-1
        run: |
          pytest

      - name: Upload coverage artifact
        uses: actions/upload-artifact@v6
        with:
          name: reporter-coverage
          path: lambda/reporter/coverage.xml
          retention-days: 1

      - name: Upload coverage reports to Codecov
        uses: codecov/codecov-action@v5
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: ./lambda/reporter/coverage.xml
          flags: reporter
          name: reporter-coverage
          fail_ci_if_error: false

      - name: Comment PR with Test Results
        if: false # Disabled: github.event_name == 'pull_request' && failure()
        uses: actions/github-script@v8
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const output = `#### Reporter Lambda Tests Failed ❌

            **Pytest execution failed or coverage is below 80%.**

            Please review the test results above and fix any failing tests or improve test coverage.

            *Pushed by: @${{ github.actor }}, Action: \`${{ github.event_name }}\`*`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: output
            });

  # Stage 3: Terraform unit tests (runs after Lambda tests complete successfully)
  terraform-unit-tests:
    name: Terraform Unit Tests (${{ matrix.test_file }})
    runs-on: ubuntu-latest
    needs: [terraform-validation, tfsec-scan, lint, scheduler-tests, purchaser-tests, reporter-tests]
    permissions:
      contents: read

    strategy:
      fail-fast: false
      matrix:
        test_file:
          - cloudwatch
          - eventbridge
          - iam
          - s3
          - sns
          - sqs
          - sqs_policy
          - variables

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: "1.11.0"

      - name: Verify Terraform Version
        run: |
          terraform version
          terraform version | grep -E "v1\.1[1-9]|v1\.[2-9][0-9]|v[2-9]" || (echo "ERROR: Terraform 1.11+ required for override_during support" && exit 1)

      - name: Verify AWS Credentials NOT Set
        run: |
          echo "Verifying tests run without AWS credentials..."
          if [ -n "$AWS_ACCESS_KEY_ID" ] || [ -n "$AWS_SECRET_ACCESS_KEY" ]; then
            echo "ERROR: AWS credentials should not be set for these tests"
            exit 1
          fi
          echo "✓ AWS credentials not set (as expected)"

      - name: Initialize Terraform
        run: |
          terraform init
          echo "✓ Terraform initialized successfully"

      - name: Run Terraform Unit Test - ${{ matrix.test_file }}
        run: |
          echo "Running ${{ matrix.test_file }} tests..."
          terraform test terraform-tests/unit/${{ matrix.test_file }}.tftest.hcl
          TEST_EXIT_CODE=$?
          echo "Test exit code: $TEST_EXIT_CODE"

          if [ $TEST_EXIT_CODE -eq 0 ]; then
            echo "✅ ${{ matrix.test_file }} tests passed!"
          else
            echo "❌ ${{ matrix.test_file }} tests failed with exit code $TEST_EXIT_CODE"
            exit $TEST_EXIT_CODE
          fi

      - name: Test Summary
        if: always()
        run: |
          echo "========================================="
          echo "Terraform Unit Test Summary: ${{ matrix.test_file }}"
          echo "========================================="
          echo "Version: $(terraform version -json | jq -r '.terraform_version')"
          echo "AWS Credentials: NOT REQUIRED ✓"
          echo "Mock Provider: ENABLED ✓"
          echo "Test File: terraform-tests/unit/${{ matrix.test_file }}.tftest.hcl"
          echo "========================================="

  # Stage 3: Terraform integration tests (runs only after unit tests pass)
  terraform-integration-tests:
    name: Terraform Integration Tests
    runs-on: ubuntu-latest
    needs: [terraform-validation, tfsec-scan, lint, terraform-unit-tests]
    concurrency:
      group: aws-integration-tests
      cancel-in-progress: false
    timeout-minutes: 30
    permissions:
      contents: read

    env:
      AWS_DEFAULT_REGION: us-east-1
      GO_VERSION: '1.24'
      TERRAFORM_VERSION: '1.11.0'

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set up Go
        uses: actions/setup-go@v6
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true
          cache-dependency-path: terraform-tests/integration/go.mod

      - name: Set up Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}
          terraform_wrapper: false

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v6
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_DEFAULT_REGION }}

      - name: Pre-Test Cleanup
        working-directory: terraform-tests/integration
        run: |
          echo "Cleaning up any orphaned resources before tests..."
          go mod download
          go test -v -timeout 10m -run TestCleanupAllOrphanedResources || true

      - name: Install Terratest Dependencies
        working-directory: terraform-tests/integration
        run: |
          go mod tidy
          go mod download
          go mod verify

      - name: Run Terratest Integration Tests
        working-directory: terraform-tests/integration
        run: |
          go test -v -timeout 30m -parallel 1 -failfast -skip TestCleanupAllOrphanedResources
        env:
          TF_VAR_environment: ci-test
          TF_VAR_project_name: sp-autopilot-ci

      - name: Cleanup Resources on Failure
        if: failure()
        working-directory: terraform-tests/integration
        run: |
          echo "Cleaning up any remaining test resources after failure..."
          go test -v -timeout 10m -run TestCleanupAllOrphanedResources || true

      - name: Comment PR with Test Results
        if: false # Disabled: github.event_name == 'pull_request' && failure()
        uses: actions/github-script@v8
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const output = `#### Terraform Integration Tests Failed ❌

            **Terratest integration tests failed.**

            Please review the test results above and fix any failing tests.

            *Pushed by: @${{ github.actor }}, Action: \`${{ github.event_name }}\`*`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: output
            });

  # Cleanup job that ALWAYS runs after integration tests
  cleanup-aws-resources:
    name: Cleanup AWS Resources
    runs-on: ubuntu-latest
    needs: terraform-integration-tests
    concurrency:
      group: aws-integration-tests
      cancel-in-progress: false
    if: always()
    timeout-minutes: 15
    permissions:
      contents: read

    env:
      AWS_DEFAULT_REGION: us-east-1
      GO_VERSION: '1.24'

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set up Go
        uses: actions/setup-go@v6
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true
          cache-dependency-path: terraform-tests/integration/go.mod

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v6
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_DEFAULT_REGION }}

      - name: Install Dependencies
        working-directory: terraform-tests/integration
        run: |
          go mod tidy
          go mod download
          go mod verify

      - name: Run Cleanup
        working-directory: terraform-tests/integration
        run: |
          echo "Running cleanup of all orphaned test resources..."
          go test -v -timeout 15m -run TestCleanupAllOrphanedResources
        continue-on-error: true

      - name: Cleanup Summary
        if: always()
        run: |
          echo "========================================="
          echo "AWS Resource Cleanup Complete"
          echo "========================================="
          echo "All orphaned test resources have been cleaned up to prevent AWS charges."
