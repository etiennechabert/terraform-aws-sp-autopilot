name: Terraform Integration Tests

on:
  pull_request:
    branches:
      - main
      - develop
    paths:
      - '**.tf'
      - 'lambda/**'
      - 'terraform-tests/integration/**'
      - '.github/workflows/terraform-integration-tests.yml'
  workflow_dispatch:
    inputs:
      test_filter:
        description: 'Test filter pattern (e.g., TestTerraformBasicDeployment)'
        required: false
        default: ''
      aws_region:
        description: 'AWS region for testing'
        required: false
        default: 'us-east-1'

permissions:
  contents: read
  pull-requests: write

jobs:
  terratest:
    name: Run Terratest Integration Tests
    runs-on: ubuntu-latest
    timeout-minutes: 30

    env:
      AWS_DEFAULT_REGION: ${{ github.event.inputs.aws_region || 'us-east-1' }}
      GO_VERSION: '1.21'
      TERRAFORM_VERSION: '1.11.0'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true
          cache-dependency-path: terraform-tests/integration/go.mod

      - name: Set up Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}
          terraform_wrapper: false

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_DEFAULT_REGION }}

      - name: Verify AWS credentials
        run: |
          aws sts get-caller-identity
          echo "AWS credentials configured successfully"

      - name: Clean up orphaned resources
        run: |
          echo "Cleaning up orphaned CloudWatch log groups from previous test runs..."
          # Delete CloudWatch log groups that may have been left behind
          aws logs describe-log-groups \
            --log-group-name-prefix "/aws/lambda/sp-autopilot" \
            --region ${{ env.AWS_DEFAULT_REGION }} \
            --query 'logGroups[*].logGroupName' \
            --output text | tr '\t' '\n' | while read -r log_group; do
            if [ -n "$log_group" ]; then
              echo "Deleting log group: $log_group"
              aws logs delete-log-group --log-group-name "$log_group" --region ${{ env.AWS_DEFAULT_REGION }} || true
            fi
          done
          echo "Cleanup complete"

      - name: Download Go modules
        working-directory: terraform-tests/integration
        run: |
          go mod tidy
          go mod download
          go mod verify

      - name: Run Terratest
        working-directory: terraform-tests/integration
        env:
          TEST_FILTER: ${{ github.event.inputs.test_filter }}
        run: |
          if [ -n "$TEST_FILTER" ]; then
            echo "Running tests matching pattern: $TEST_FILTER"
            go test -v -timeout 30m -run "$TEST_FILTER"
          else
            echo "Running all Terratest integration tests"
            go test -v -timeout 30m
          fi

      - name: Cleanup on failure
        if: failure()
        working-directory: terraform-tests/integration
        run: |
          echo "Attempting to clean up any orphaned resources..."
          # Try to destroy any partial deployments
          if [ -d "fixtures/basic/.terraform" ]; then
            cd fixtures/basic
            terraform destroy -auto-approve || echo "No resources to destroy or cleanup failed"
          fi

      - name: Post test results
        if: always() && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const outcome = '${{ job.status }}';
            const emoji = outcome === 'success' ? '✅' : '❌';
            const message = `${emoji} Terratest Integration Tests ${outcome === 'success' ? 'passed' : 'failed'}`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: message
            });
