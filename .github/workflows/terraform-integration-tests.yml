name: Terraform Integration Tests

on:
  pull_request:
    branches:
      - main
      - develop
    paths:
      - '**.tf'
      - 'lambda/**'
      - 'terraform-tests/integration/**'
      - '.github/workflows/terraform-integration-tests.yml'
  workflow_dispatch:
    inputs:
      test_filter:
        description: 'Test filter pattern (e.g., TestTerraformBasicDeployment)'
        required: false
        default: ''
      aws_region:
        description: 'AWS region for testing'
        required: false
        default: 'us-east-1'

permissions:
  contents: read
  pull-requests: write

jobs:
  terratest:
    name: Run Terratest Integration Tests
    runs-on: ubuntu-latest
    timeout-minutes: 30

    env:
      AWS_DEFAULT_REGION: ${{ github.event.inputs.aws_region || 'us-east-1' }}
      GO_VERSION: '1.21'
      TERRAFORM_VERSION: '1.11.0'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true
          cache-dependency-path: terraform-tests/integration/go.mod

      - name: Set up Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}
          terraform_wrapper: false

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_DEFAULT_REGION }}

      - name: Verify AWS credentials
        run: |
          aws sts get-caller-identity
          echo "AWS credentials configured successfully"

      - name: Clean up orphaned resources
        run: |
          echo "=========================================="
          echo "Cleaning up orphaned AWS resources from previous test runs..."
          echo "=========================================="

          # Note: We clean up resources in both us-east-1 and us-west-2 since tests use random regions
          for region in us-east-1 us-west-2; do
            echo ""
            echo "Cleaning up resources in $region..."

            # 1. Delete Lambda functions
            echo "  - Deleting Lambda functions..."
            for func in sp-autopilot-scheduler sp-autopilot-purchaser sp-autopilot-reporter; do
              aws lambda delete-function --function-name $func --region $region 2>/dev/null && echo "    ✓ Deleted Lambda: $func" || true
            done

            # 2. Delete EventBridge rules (must delete targets first)
            echo "  - Deleting EventBridge rules..."
            for rule in sp-autopilot-scheduler sp-autopilot-purchaser; do
              # Remove all targets from rule
              aws events remove-targets --rule $rule --ids $(aws events list-targets-by-rule --rule $rule --region $region --query 'Targets[*].Id' --output text 2>/dev/null) --region $region 2>/dev/null || true
              # Delete rule
              aws events delete-rule --name $rule --region $region 2>/dev/null && echo "    ✓ Deleted EventBridge rule: $rule" || true
            done

            # 3. Delete CloudWatch alarms
            echo "  - Deleting CloudWatch alarms..."
            for alarm in sp-autopilot-scheduler-errors sp-autopilot-purchaser-errors sp-autopilot-reporter-errors sp-autopilot-dlq-messages; do
              aws cloudwatch delete-alarms --alarm-names $alarm --region $region 2>/dev/null && echo "    ✓ Deleted alarm: $alarm" || true
            done

            # 4. Delete CloudWatch log groups
            echo "  - Deleting CloudWatch log groups..."
            aws logs describe-log-groups \
              --log-group-name-prefix "/aws/lambda/sp-autopilot" \
              --region $region \
              --query 'logGroups[*].logGroupName' \
              --output text 2>/dev/null | tr '\t' '\n' | while read -r log_group; do
              if [ -n "$log_group" ]; then
                aws logs delete-log-group --log-group-name "$log_group" --region $region 2>/dev/null && echo "    ✓ Deleted log group: $log_group" || true
              fi
            done

            # 5. Delete SQS queues
            echo "  - Deleting SQS queues..."
            for queue_name in sp-autopilot-purchase-intents sp-autopilot-purchase-intents-dlq; do
              queue_url=$(aws sqs get-queue-url --queue-name $queue_name --region $region --query 'QueueUrl' --output text 2>/dev/null) || true
              if [ -n "$queue_url" ]; then
                aws sqs delete-queue --queue-url "$queue_url" --region $region 2>/dev/null && echo "    ✓ Deleted SQS queue: $queue_name" || true
              fi
            done

            # 6. Delete SNS topic (must delete subscriptions first)
            echo "  - Deleting SNS topics..."
            topic_arn=$(aws sns list-topics --region $region --query "Topics[?contains(TopicArn, 'sp-autopilot-notifications')].TopicArn" --output text 2>/dev/null) || true
            if [ -n "$topic_arn" ]; then
              # Delete all subscriptions
              aws sns list-subscriptions-by-topic --topic-arn "$topic_arn" --region $region --query 'Subscriptions[*].SubscriptionArn' --output text 2>/dev/null | tr '\t' '\n' | while read -r sub_arn; do
                if [ -n "$sub_arn" ] && [ "$sub_arn" != "None" ] && [ "$sub_arn" != "PendingConfirmation" ]; then
                  aws sns unsubscribe --subscription-arn "$sub_arn" --region $region 2>/dev/null || true
                fi
              done
              # Delete topic
              aws sns delete-topic --topic-arn "$topic_arn" --region $region 2>/dev/null && echo "    ✓ Deleted SNS topic: sp-autopilot-notifications" || true
            fi

            # 7. Delete IAM role policies and roles (IAM is global, so only do this once)
            if [ "$region" == "us-east-1" ]; then
              echo "  - Deleting IAM roles and policies..."
              for role in sp-autopilot-scheduler sp-autopilot-purchaser sp-autopilot-reporter; do
                # Delete inline policies
                aws iam list-role-policies --role-name $role --query 'PolicyNames[*]' --output text 2>/dev/null | tr '\t' '\n' | while read -r policy; do
                  if [ -n "$policy" ]; then
                    aws iam delete-role-policy --role-name $role --policy-name "$policy" 2>/dev/null || true
                  fi
                done
                # Detach managed policies
                aws iam list-attached-role-policies --role-name $role --query 'AttachedPolicies[*].PolicyArn' --output text 2>/dev/null | tr '\t' '\n' | while read -r policy_arn; do
                  if [ -n "$policy_arn" ]; then
                    aws iam detach-role-policy --role-name $role --policy-arn "$policy_arn" 2>/dev/null || true
                  fi
                done
                # Delete role
                aws iam delete-role --role-name $role 2>/dev/null && echo "    ✓ Deleted IAM role: $role" || true
              done
            fi
          done

          echo ""
          echo "=========================================="
          echo "Cleanup complete"
          echo "=========================================="

      - name: Download Go modules
        working-directory: terraform-tests/integration
        run: |
          go mod tidy
          go mod download
          go mod verify

      - name: Validate test fixtures
        working-directory: terraform-tests/integration/fixtures/basic
        run: |
          echo "=========================================="
          echo "Validating test fixture configuration"
          echo "=========================================="
          terraform init -backend=false
          terraform validate
          echo "✓ Test fixture validation passed"

      - name: Run Terratest
        working-directory: terraform-tests/integration
        env:
          TEST_FILTER: ${{ github.event.inputs.test_filter }}
        run: |
          if [ -n "$TEST_FILTER" ]; then
            echo "Running tests matching pattern: $TEST_FILTER"
            go test -v -timeout 30m -run "$TEST_FILTER"
          else
            echo "Running all Terratest integration tests"
            go test -v -timeout 30m
          fi

      - name: Cleanup on failure
        if: failure()
        working-directory: terraform-tests/integration
        run: |
          echo "Attempting to clean up any orphaned resources..."
          # Try to destroy any partial deployments
          if [ -d "fixtures/basic/.terraform" ]; then
            cd fixtures/basic
            terraform destroy -auto-approve || echo "No resources to destroy or cleanup failed"
          fi

      - name: Post test results
        if: always() && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const outcome = '${{ job.status }}';
            const emoji = outcome === 'success' ? '✅' : '❌';
            const message = `${emoji} Terratest Integration Tests ${outcome === 'success' ? 'passed' : 'failed'}`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: message
            });
