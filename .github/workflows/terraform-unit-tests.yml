name: Terraform Unit Tests

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

jobs:
  terraform-tests:
    name: Run Terraform Tests (No AWS Credentials)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: "1.11.0"

      - name: Verify Terraform Version
        run: |
          terraform version
          terraform version | grep -E "v1\.1[1-9]|v1\.[2-9][0-9]|v[2-9]" || (echo "ERROR: Terraform 1.11+ required for override_during support" && exit 1)

      - name: Verify AWS Credentials NOT Set
        run: |
          echo "Verifying tests run without AWS credentials..."
          if [ -n "$AWS_ACCESS_KEY_ID" ] || [ -n "$AWS_SECRET_ACCESS_KEY" ]; then
            echo "ERROR: AWS credentials should not be set for these tests"
            exit 1
          fi
          echo "✓ AWS credentials not set (as expected)"

      - name: Initialize Terraform
        run: |
          terraform init
          echo "✓ Terraform initialized successfully"

      - name: Run Terraform Tests
        run: |
          echo "Running all Terraform tests..."
          terraform test -verbose -test-directory=terraform-tests/unit
          TEST_EXIT_CODE=$?
          echo "Test exit code: $TEST_EXIT_CODE"

          if [ $TEST_EXIT_CODE -eq 0 ]; then
            echo "✅ All tests passed!"
          else
            echo "❌ Tests failed with exit code $TEST_EXIT_CODE"
            exit $TEST_EXIT_CODE
          fi

      - name: Verify No Credential Errors
        run: |
          echo "Checking for credential-related errors..."
          terraform test -test-directory=terraform-tests/unit 2>&1 | tee test_output.log

          if grep -iE "(credential|authentication|no valid credential|unable to locate credential)" test_output.log; then
            echo "❌ FAILURE: Credential-related errors detected"
            exit 1
          else
            echo "✅ No credential errors detected"
          fi

      - name: Test Summary
        if: always()
        run: |
          echo "========================================="
          echo "Terraform Native Tests Summary"
          echo "========================================="
          echo "Version: $(terraform version -json | jq -r '.terraform_version')"
          echo "AWS Credentials: NOT REQUIRED ✓"
          echo "Mock Provider: ENABLED ✓"
          echo "Test Files: $(ls -1 terraform-tests/unit/*.tftest.hcl 2>/dev/null | wc -l)"
          echo "========================================="

  test-file-validation:
    name: Validate Test File Structure
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Validate Test Files Exist
        run: |
          echo "Checking for required test files..."
          REQUIRED_FILES=(
            "terraform-tests/unit/s3.tftest.hcl"
            "terraform-tests/unit/sqs.tftest.hcl"
            "terraform-tests/unit/sns.tftest.hcl"
            "terraform-tests/unit/iam.tftest.hcl"
            "terraform-tests/unit/cloudwatch.tftest.hcl"
            "terraform-tests/unit/eventbridge.tftest.hcl"
            "terraform-tests/unit/variables.tftest.hcl"
          )

          for file in "${REQUIRED_FILES[@]}"; do
            if [ -f "$file" ]; then
              echo "✓ $file exists"
            else
              echo "✗ $file MISSING"
              exit 1
            fi
          done

      - name: Validate Mock Provider Configuration
        run: |
          echo "Checking all test files have mock_provider..."
          for file in terraform-tests/unit/*.tftest.hcl; do
            if grep -q 'mock_provider "aws"' "$file"; then
              echo "✓ $file has mock_provider"
            else
              echo "✗ $file MISSING mock_provider"
              exit 1
            fi
          done

      - name: Validate No Apply Commands
        run: |
          echo "Ensuring no tests use 'command = apply'..."
          if grep -r "command = apply" terraform-tests/unit/; then
            echo "✗ FAILURE: Found 'command = apply' in tests (should use 'command = plan')"
            exit 1
          else
            echo "✓ All tests use 'command = plan'"
          fi

      - name: Count Test Coverage
        run: |
          echo "========================================="
          echo "Test Coverage Statistics"
          echo "========================================="
          echo "Test files: $(ls -1 terraform-tests/unit/*.tftest.hcl 2>/dev/null | wc -l)"
          echo "Total test runs: $(grep -r 'run "' terraform-tests/unit/ | wc -l)"
          echo "Total assertions: $(grep -r 'assert {' terraform-tests/unit/ | wc -l)"
          echo "Validation tests: $(grep -r 'expect_failures' terraform-tests/unit/ | wc -l)"
          echo "========================================="
